name: ğŸ§ª CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      triggered_by:
        description: 'Triggered by workflow'
        required: false
        default: 'manual'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Check code formatting
  fmt:
    name: ğŸ¨ Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  # Run clippy lints
  clippy:
    name: ğŸ“ Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # Build WASM library
  build-wasm:
    name: ğŸ•¸ï¸ Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2

      # Install wasm-pack
      - name: ğŸ“¦ Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # Build WASM library
      - name: ğŸ”¨ Build WASM
        run: ./build-wasm.sh

      # Upload WASM artifacts
      - name: ğŸ“¤ Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-build
          path: pkg/

  # Build example application
  build-example:
    name: ğŸ¯ Build Example
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2

      # Install wasm-pack
      - name: ğŸ“¦ Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # Setup Node.js
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'

      # Build WASM library first
      - name: ğŸ”¨ Build WASM
        run: ./build-wasm.sh

      # Build example
      - name: ğŸ”¨ Build Example
        run: |
          cd example
          npm install
          npm run build

      # Upload example artifacts
      - name: ğŸ“¤ Upload Example artifacts
        uses: actions/upload-artifact@v4
        with:
          name: example-build
          path: example/dist/

  # Documentation build
  docs:
    name: ğŸ“š Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
      - name: ğŸ“š Build docs
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: --cfg docsrs
      - name: ğŸ“¤ Upload docs
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: target/doc/
